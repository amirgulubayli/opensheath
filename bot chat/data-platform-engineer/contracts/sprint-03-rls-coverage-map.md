# Sprint 03 RLS Coverage Map (Tenant Isolation Gate)

Date: 2026-02-07
Owner: Data Platform Engineer
Reviewers: Backend Engineer, Security/Compliance Engineer, QA/Release Engineer

## Policy Classes

- `tenant_member_read`: workspace members can read.
- `tenant_writer_mutate`: workspace members with write permission can insert/update.
- `tenant_owner_admin`: owner/admin-only sensitive operations.
- `service_role_only`: internal system jobs only.

## Coverage Matrix

| Table | Tenant Scoped (`workspace_id`) | Read Policy | Write Policy | Admin Policy | Notes |
|---|---|---|---|---|---|
| `workspaces` | Yes | `tenant_member_read` | `tenant_owner_admin` | `tenant_owner_admin` | Ownership transfer paths audited. |
| `workspace_memberships` | Yes | `tenant_member_read` | `tenant_owner_admin` | `tenant_owner_admin` | Prevent orphaned owner. |
| `projects` | Yes | `tenant_member_read` | `tenant_writer_mutate` | `tenant_owner_admin` | Domain ownership enforced. |
| `items` | Yes | `tenant_member_read` | `tenant_writer_mutate` | `tenant_owner_admin` | State transition validation upstream. |
| `documents` | Yes | `tenant_member_read` | `tenant_writer_mutate` | `tenant_owner_admin` | Ingestion status mutation path controlled. |
| `activity_logs` | Yes | `tenant_member_read` | `service_role_only` | `tenant_owner_admin` | Append-only recommended. |
| `document_chunks` | Yes | `tenant_member_read` | `service_role_only` | `tenant_owner_admin` | Generated by ingestion jobs. |
| `embeddings` | Yes | `tenant_member_read` | `service_role_only` | `tenant_owner_admin` | Model version fields required. |
| `agent_threads` | Yes | `tenant_member_read` | `tenant_writer_mutate` | `tenant_owner_admin` | Thread ownership validated. |
| `agent_runs` | Yes | `tenant_member_read` | `service_role_only` | `tenant_owner_admin` | Runtime writes via trusted services. |
| `tool_calls` | Yes | `tenant_member_read` | `service_role_only` | `tenant_owner_admin` | Idempotency required. |
| `integrations` | Yes | `tenant_member_read` | `tenant_owner_admin` | `tenant_owner_admin` | Credential metadata only in DB. |
| `integration_events` | Yes | `tenant_member_read` | `service_role_only` | `tenant_owner_admin` | Dedupe by source event id. |
| `subscriptions` | Yes | `tenant_member_read` | `service_role_only` | `tenant_owner_admin` | Source-of-truth synced from webhooks. |
| `entitlements` | Yes | `tenant_member_read` | `service_role_only` | `tenant_owner_admin` | Deterministic plan mapping. |
| `usage_counters` | Yes | `tenant_member_read` | `service_role_only` | `tenant_owner_admin` | Atomic increment controls required. |
| `audit_logs` | Yes | `tenant_owner_admin` | `service_role_only` | `tenant_owner_admin` | Immutable/append-only behavior. |
| `job_runs` | Optional* | `service_role_only` | `service_role_only` | `tenant_owner_admin` | Include `workspace_id` when job is tenant-scoped. |
| `dead_letter_jobs` | Optional* | `service_role_only` | `service_role_only` | `tenant_owner_admin` | Tenant scope required for tenant-origin events. |

## Test Expectations

1. Positive policy tests per table and role.
2. Negative cross-tenant read/write tests for all tenant tables.
3. Service-role path tests for system-only mutation tables.

## Gate Evidence Required

1. Coverage matrix approved by security.
2. Regression tests passing in CI.
3. Migration guard enforcing policy coverage enabled.
